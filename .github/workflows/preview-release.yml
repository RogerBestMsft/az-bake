name: Preview Release

on:
  workflow_dispatch:
    inputs:
      suffix:
        description: 'Preview version suffix (e.g. alpha, beta, rc1). Defaults to "dev".'
        required: false
        default: 'dev'

# only allow one preview release at a time per branch
concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: builder
  IMAGE_REGISTRY: ghcr.io

jobs:
  preview:
    name: Create Preview Release
    if: github.ref_name != 'main'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Everything added to release_assets will be published as an asset on the release
      - name: Create Assets Directory
        run: mkdir -p release_assets

      - name: Get base CLI version
        id: base_version
        run: python ./tools/cli-version.py

      - name: Compute preview version
        id: preview_version
        run: |
          BASE_VERSION="${{ steps.base_version.outputs.version }}"
          SUFFIX="${{ github.event.inputs.suffix }}"
          SHORT_SHA="${GITHUB_SHA::7}"
          PREVIEW_VERSION="${BASE_VERSION}${SUFFIX}${GITHUB_RUN_NUMBER}.${SHORT_SHA}"
          echo "version=${PREVIEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Preview version: ${PREVIEW_VERSION}"

      - name: Stamp preview version into setup.py
        run: |
          PREVIEW_VERSION="${{ steps.preview_version.outputs.version }}"
          sed -i "s/^VERSION = .*/VERSION = '${PREVIEW_VERSION}'/" bake/setup.py
          echo "--- setup.py version ---"
          grep VERSION bake/setup.py

      - name: Build CLI
        run: bash ./tools/build-cli.sh

      # This must be run LAST - AFTER everything is added to release_assets
      - name: Prepare Release Assets
        id: prepare_assets
        run: python ./tools/prepare-assets.py

      - name: Delete existing preview tag (if any)
        run: |
          TAG="v${{ steps.preview_version.outputs.version }}"
          git push origin ":refs/tags/${TAG}" 2>/dev/null || true

      - name: Create Pre-Release
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');

            const assets = JSON.parse('${{ steps.prepare_assets.outputs.assets }}');
            const version = '${{ steps.preview_version.outputs.version }}';
            const branch  = '${{ github.ref_name }}';
            const tag     = `v${version}`;

            const release = (await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              target_commitish: '${{ github.sha }}',
              name: `${tag} (preview)`,
              body: `Preview build from branch **${branch}** at \`${{ github.sha }}\`.\n\nInstall with:\n\`\`\`bash\naz extension add --source <wheel-url>\n\`\`\``,
              prerelease: true,
            })).data;

            for (const a of assets) {
              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id,
                name: a.name,
                data: fs.readFileSync(a.path),
              });
            }
